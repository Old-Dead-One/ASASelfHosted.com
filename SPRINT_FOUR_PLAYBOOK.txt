Sprint 4 Implementation Playbook
Agent Pipeline, Heartbeats, Trust, and Derived Metrics

Sprint 4 Objective
Transform the directory from a static listing service into a living, trusted system by introducing:
Real-time server heartbeats
Secure agent authentication
Deterministic status transitions
Computed uptime and quality metrics
Verified trust signals
Sprint 4 introduces time, causality, and confidence into the platform.
Core Principles (Non-Negotiable)
Append-only telemetry
Heartbeats are immutable records.
Never “fix” history.
Snapshot + history split
heartbeats = history
servers = latest derived state only
Python owns logic
Status transitions
Confidence
Uptime math
Quality scoring
Verification rules
SQL stores facts, not opinions
No hidden logic in views or triggers
No “smart” SQL
Trust is explicit
is_verified is not inferred
Agent identity is cryptographically proven
High-Level Architecture
Agent → POST /agent/heartbeat
        ↓
 Signature Verification
        ↓
 Heartbeat Persisted (append-only)
        ↓
 Status / Confidence Engine
        ↓
 Derived Metrics Engine
        ↓
 servers table updated (latest snapshot)

Directory read paths remain unchanged.

Phase 4.1 — Agent Authentication & Identity
Agent Identity Model

Each server has:
server_id
cluster_id
key_version
public_fingerprint (stored)
Private key lives only on the agent
Signature Rules
Agent signs payload using private key
Server validates using stored public fingerprint
Reject if:
Signature invalid
Key version mismatch
Server is unverified (configurable)
Why this matters

This prevents:
Spoofed servers
Fake uptime
Inflated player counts
Trust begins here.

Phase 4.2 — Heartbeat API
Endpoint
POST /agent/heartbeat

Payload (example)
{
  "server_id": "uuid",
  "key_version": 1,
  "timestamp": "2026-01-22T21:05:00Z",
  "status": "online",
  "map_name": "The Island",
  "players_current": 42,
  "players_capacity": 70,
  "agent_version": "1.0.3",
  "payload": {
    "raw": "optional diagnostic blob"
  },
  "signature": "base64"
}

Behavior
Validate signature
Persist heartbeat
Invoke derived state update
Return 202 Accepted
Failure Modes
Invalid signature → 401
Unknown server → 404
Key mismatch → 409
Rate limit exceeded → 429

Phase 4.3 — Heartbeat Persistence
Table: heartbeats
Append-only. No updates. Ever.
Stored fields:
server_id
received_at
status
map_name
players_current
players_capacity
agent_version
payload
signature

Indexes:
(server_id, received_at DESC)
(received_at DESC)

Phase 4.4 — Status Engine
Status Transition Rules
Condition	Result
Recent heartbeat < grace window	online
Missed grace window	offline
Never seen / unknown	unknown
Grace Window (configurable)
Default: 5–10 minutes
Prevents flapping
Stored On servers
effective_status
last_seen_at
status_source = 'agent'

Phase 4.5 — Confidence Engine
Confidence reflects trustworthiness, not status.
Confidence States
green: agent verified + consistent
yellow: intermittent or new
red: stale, inconsistent, or spoof attempts
Inputs
Heartbeat consistency
Agent version
Signature validity
Historical uptime
Stored as:
confidence TEXT -- green/yellow/red

Phase 4.6 — Uptime Computation
Strategy
Compute uptime from heartbeat presence over rolling windows
Start with 24h window only
Algorithm (v1)
uptime_percent =
  (minutes_online / total_minutes_in_window) * 100
Stored On servers
uptime_percent DOUBLE PRECISION
History remains in heartbeats.

Phase 4.7 — Quality Score Engine
Inputs (v1)
Uptime %
Player activity consistency
Agent reliability
Example Formula (simple on purpose)
quality =
  uptime_weight * uptime_percent
  + activity_weight * normalized_players
  - penalty_flapping

Store:
quality_score DOUBLE PRECISION
Do not over-engineer v1.

Phase 4.8 — Verification Semantics (Finalize)
is_verified meaning
“This server identity is trusted and authenticated.”

Rules:
Only verified servers may:
Submit agent heartbeats
Affect ranking weight (later)
Manual listings remain visible but lower trust
This is your moat.
Phase 4.9 — Ranking Prep (No behavior change yet)
Sprint 4 does not change ordering.

But:
quality_score
uptime_percent
players_current
Are now real, enabling Sprint 5 ranking modes.

Phase 4.10 — Observability & Safety
Logging
Signature failures
Rejected heartbeats
Status transitions
Rate Limits
Per server
Per IP
Feature Flags
Agent enforcement
Verification enforcement
Non-Goals (Explicitly Out of Scope)
Materialized views
Trending math
Badge UI logic
Client-side changes
Monetization gating
Historical analytics UI

Exit Criteria (Sprint 4 Complete When)
✅ Agents can submit heartbeats securely
✅ Heartbeats persist append-only
✅ Servers update derived state correctly
✅ Status & confidence change deterministically
✅ Uptime & quality are populated
✅ Directory endpoints unchanged
✅ No trust logic in SQL
✅ Spoofing attempts are rejected

What Comes After (Sprint 5 Preview)
Real ranking modes (players, uptime, quality)
Trending math
Badge engine
Caching strategies
Public trust indicators