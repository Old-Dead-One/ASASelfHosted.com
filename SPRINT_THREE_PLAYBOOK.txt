Sprint 3 — Canonical Definition (Locked)

Supabase Read Model & Ranking Foundations
Purpose:
Replace mock behavior with real, queryable, indexed Supabase data while keeping all existing API contracts intact.

Entry Conditions (Met)
✅ Sprint 2 API contracts locked
✅ Repository seam in place
✅ MockDirectoryRepository fully functional
✅ Frontend not hardcoding logic
✅ Supabase repo stubbed and fail-fast

You’re allowed to start.

Sprint 3 Deliverables (Complete List)
3.1 directory_view (Required)
SQL VIEW or MATERIALIZED VIEW
Matches DirectoryServer schema exactly
Contains:
canonical fields
legacy aliases (if still present)
derived booleans (is_modded, is_crossplay, etc.)
No write paths
No business logic leakage into API layer
This is the single most important artifact of Sprint 3.

3.2 SupabaseDirectoryRepository — Implemented
list_servers() implemented
SQL filtering for:
ruleset
game_mode
status
verification
players ranges
tri-state flags
Pagination via LIMIT / OFFSET
Sorting:
updated fully supported
others accepted, internally fallback
No API changes. No frontend changes.

3.3 Indexing Strategy (Minimal & Intentional)
Required indexes only:
updated_at DESC
ruleset
game_mode
effective_status
cluster_id
is_verified
players_current (nullable-safe)
Indexes are part of Sprint 3, not “later.”

3.4 Ranking Fields Populated
rank_position computed per query
rank_by echoed correctly
rank_delta_24h:
nullable
or placeholder
or snapshot-based if trivial
Trending math starts, but does not need to be clever yet.

3.5 Real Facets (get_filters)
Derived from Supabase, not mock data
Uses DISTINCT, MIN, MAX
No frontend hardcoding required

3.6 Fail-Fast Guarantees
Non-local ENV must use Supabase
Missing config → loud failure
Unsupported operations → HTTP 501 (not 500)
Explicit Non-Goals (Critical)

Sprint 3 does not include:
❌ Badge engine logic
❌ Carousels
❌ “Top / Hot / Trending” UI
❌ Feature flags
❌ Owner diagnostics UI
❌ Advanced boolean search

If you add any of these, you are breaking sprint discipline.

Exit Criteria (This Is What “Done” Means)
Sprint 3 is complete when:
Mock repo can be turned off in staging
SupabaseDirectoryRepository serves real data
GET /directory/servers behaves identically to Sprint 2
Frontend does not change
No contracts change
No TODOs exist outside Supabase implementation details
If all of that is true, Sprint 4 can start cleanly.

Sprint 3 Apendix:

Supabase Project Setup:
1. Create the Supabase project (clean, boring, correct)
New project
No auth tweaks yet
No RLS heroics yet
Default Postgres is fine
Name it something obvious like: asa-self-hosted-directory
Old-school rule: boring names age best.

2. Create tables (minimum viable)
Do not over-model. Sprint 3 needs readability, not perfection.
Minimum tables you actually need now:
servers
clusters (optional but recommended)
server_status or heartbeats (even if sparse)
favorites (can be empty, future-proofing only)
If a table doesn’t feed directory_view, it doesn’t belong in Sprint 3.

3. Build directory_view (this is the spine)
This is the real deliverable of Sprint 3.
Rules:
One row = one public server
No joins that aren’t strictly necessary
All booleans resolved here (is_modded, is_crossplay, etc.)
All nullable handled cleanly
No application logic leaks
You are building a read model, not a mirror of tables.
If you want a mental model:
“What would I want if I had to answer the directory API with one SELECT?”
That’s your view.

4. Index like an adult
Add indexes only for:
updated_at DESC
ruleset
game_mode
effective_status
cluster_id
players_current
is_verified
No speculative indexes. No premature cleverness.

5. Wire SupabaseDirectoryRepository (minimally)
Sprint 3 rules:
Implement list_servers
Implement get_server
Implement get_filters
Ranking: updated only
Others: accepted, fallback internally
If you’re tempted to implement fancy ranking math:
Stop. That’s Sprint 4’s problem.

6. Validate against Mock behavior
Before you celebrate:
Run the same request against:
Mock repo
Supabase repo
Compare payload shape
Ignore ordering differences except updated
If they match structurally, you’re done.

7. What you explicitly do not do yet
This matters more than people think:
❌ Materialized views (unless perf forces it)
❌ Badge logic
❌ Trending math beyond placeholders
❌ Feature flags
❌ Owner/admin UX
❌ RLS gymnastics
Sprint discipline beats enthusiasm every time.